<?php

class fixit_test{

	public function __construct(){
	}
	
	
	
	
	public function main(){
		
		$testResults = $this->tests();
		
		if($testResults['all'] == 1) drupal_set_message('Passed tests');

		if($testResults['all'] == 0) drupal_set_message('Failed tests');

		dpm($testResults);
		
	}
	
	
	
	
	private function tests(){
		
		//Disable rule so we don't send any actual text messages during testing
		$rulesConfig = rules_config_load('rules_hellofixit_jobs_relay');
		$rulesConfig->active = FALSE;
		$rulesConfig->save();

		$testResults = array(	'all' => 0,
								'fixit_settings' => 0,
								'fixit_terms' => 0);
								
		//prepopulate test results array with zeros (or two for the ones you don't want to run)
		$testResults['text_in'] = array('spam' => 2,
										'spam_react' => 2,
										'take_job' => 2,
										'take_job_react' => 2,
										'feedback' => 2,
										'feedback_react' => 2,
										'add_to_job' => 2,
										'add_to_job_react' => 2,
										'update_zip' => 2,
										'update_zip_react' => 2,
										'new_fixit' => 2,
										'new_fixit_react' => 2,
										'new_customer' => 2,
										'new_customer_react' => 2,
										'new_job' => 2,
										'new_job_react' => 2);
								
		//prepopulate test results array with zeros (or two for the ones you don't want to run)
		$testResults['jobs_relay'] = array('needs_approval' => 0);

		//get settings
		//@todo - need a test for settings, so that it can't proceed without them
		$fSettings = hellofixit_settings();
		$testResults['fixit_settings'] = 1;

		//get taxonomy terms
		$terms1 = new fixit_terms();
		$fTerms = $terms1->main();
		if($fTerms['exist'] == 1){
			$testResults['fixit_terms'] = 1;
		}else{
			watchdog('hellofixit','fixit terms test failed', WATCHDOG_NOTICE);
			return $testResults;			
		}
		
		//test text_in class
		$testResults['text_in'] = $this->text_in_test($testResults['text_in'],$fTerms,$fSettings);
		
		//test jobs relay
		$testResults['jobs_relay'] = $this->jobs_relay_test ($testResults['jobs_relay'],$fTerms, $fSettings);

		//this comes last after all the tests
		//if there are any zeros in any of the tests, it keeps 'all' set to zero
		//accepts with one and two dimensional elements
		$testResults = $this->check_for_zeros($testResults);
		if(!$testResults['all'] == 1) watchdog('hellofixit','tests all not 1', WATCHDOG_NOTICE);
		
		$rulesConfig = rules_config_load('rules_hellofixit_jobs_relay');
		$rulesConfig->active = TRUE;
		$rulesConfig->save();


	return $testResults;
	}
	
	
	
	
	private function check_for_zeros($testResults){
		foreach($testResults as $i){
			if($i == 'all') continue;
			if($i == 0) return $testResults;
			if(is_array($i)){
				foreach($i as $key => $j){
					if($j == 0) return $testResults;
				}				
			}
		}
	$testResults['all'] = 1;
	return $testResults;
	}

	
	
	
	private function text_in_test(array $textInTest, array $fTerms, array $fSettings){
		if($textInTest['spam'] == 0){
			$testResults = $this->text_in_spam_test($fTerms, $fSettings);
			$textInTest['spam'] = $testResults['spam'];
			$textInTest['spam_react'] = $testResults['spam_react'];
		}

		if($textInTest['take_job'] == 0){
			$testResults = $this->text_in_take_job_test($fTerms, $fSettings);
			$textInTest['take_job'] = $testResults['take_job'];
			$textInTest['take_job_react'] = $testResults['take_job_react'];
		}
		
		if($textInTest['feedback'] == 0){
			$testResults = $this->text_in_feedback_test($fTerms, $fSettings);
			$textInTest['feedback'] = $testResults['feedback'];
			$textInTest['feedback_react'] = $testResults['feedback_react'];
		}
		
		if($textInTest['add_to_job'] == 0){
			$testResults = $this->text_in_add_to_job_test($fTerms, $fSettings);
			$textInTest['add_to_job'] = $testResults['add_to_job'];
			$textInTest['add_to_job_react'] = $testResults['add_to_job_react'];
		}
		
		if($textInTest['update_zip'] == 0){
			$testResults = $this->text_in_update_zip_test($fTerms, $fSettings);
			$textInTest['update_zip'] = $testResults['update_zip'];
			$textInTest['update_zip_react'] = $testResults['update_zip_react'];
		}
		
		if($textInTest['new_fixit'] == 0){		
			$testResults = $this->text_in_new_fixit_test($fTerms, $fSettings);
			$textInTest['new_fixit'] = $testResults['new_fixit'];
			$textInTest['new_fixit_react'] = $testResults['new_fixit_react'];
		}
		
		if($textInTest['new_customer'] == 0){
			$testResults = $this->text_in_new_customer_test($fTerms, $fSettings);
			$textInTest['new_customer'] = $testResults['new_customer'];
			$textInTest['new_customer_react'] = $testResults['new_customer_react'];
		}
		
		if($textInTest['new_job'] == 0){
			$testResults = $this->text_in_new_job_test($fTerms, $fSettings);
			$textInTest['new_job'] = $testResults['new_job'];
			$textInTest['new_job_react'] = $testResults['new_job_react'];
		}
		
	return $textInTest;
	}
	
	
	
	
	private function jobs_relay_test(array $jobsRelayTest, array $fTerms, array $fSettings){
		if($jobsRelayTest['needs_approval'] == 0){
			$jobsRelayTest['needs_approval'] = $this->jobs_relay_needs_approval_test($fTerms, $fSettings)['needs_approval'];
		}
	
	return $jobsRelayTest;
	}

	
	
	
	
	private function text_in_spam_test(array $fTerms, array $fSettings){
		
		$testResults = array('spam' => 0,
							'spam_react' => 0);

		//make a test customer
		$s1 = new person();
		$spammerNid = $s1->new_person_node('(512) 333-4444',
							$fTerms['person_types']['spammer'],
							'chrisfirst',
							'chrislast',
							'')->nid;

		//make a test fixit
		$f1 = new person();
		$fixitNid = $f1->new_person_node('(512) 777-8888',
							$fTerms['person_types']['fixit'],
							'frankfirst',
							'franklast',
							'')->nid;

		//simulate new text message
		$newText = array('cell' => '5123334444',
						'sms' => 'sms for spam test',
						'mms' => '',
						'cell_formatted' => '(512) 333-4444');
		
		//simulate a text in
		$t1 = new text_in();
		if($t1->main($newText,$fTerms,$fSettings)['spam']['value'] == 1){
			$testResults['spam'] = 1;
		}else{
			//if it failed the first test, don't do the second
			return $testResults;
		}

		//now test for spam react (second test)
		
		//test to make sure job is set to denied
		$sql = "select cr.entity_id as job_nid,
						cr.field_customer_ref_target_id as customer_nid,
						n.created as when_created
				from 	field_data_field_cell_phone cp
				join 	field_data_field_customer_ref cr on cr.field_customer_ref_target_id = cp.entity_id
				join 	node n on n.nid = cr.entity_id
				join 	field_data_field_status s on s.entity_id = cr.entity_id
				where 	cp.field_cell_phone_value = :cell_formatted
				and 	s.field_status_tid = :denied
				and 	cr.bundle = 'job'
				and 	n.created > :oneMin";

		$oneMin = time() - 60;
		$args = array(	':cell_formatted' => $newText['cell_formatted'],
						':oneMin' => $oneMin,
						':denied' => $fTerms['job_statuses']['denied']);

		$result = db_query($sql,$args)->fetchAssoc();

		if(isset($result) and !$result == NULL) $testResults['spam_react'] = 1;
		
		//cleanup
		node_delete($spammerNid);
		node_delete($fixitNid);
		node_delete($result['job_nid']);

	return $testResults;
	}

	
	
	
	function text_in_take_job_test(array $fTerms, array $fSettings){
		//array to report test results
		//need customer
		//need job
		//need fixit
		//need text out
		//make a simulated text message
		//simulate a new text coming in
		//record test result
		//query to see if job status was changed to taken
		//record test result
		//cleanup
		//return results
		
		$testResults = array('take_job' => 0,
							'take_job_react' => 0);
		
		$c1 = new person();
		$customerNid = $c1->new_person_node('(512) 333-4444',
						$fTerms['person_types']['customer'],
						'chrisfirst',
						'chrislast',
						'')->nid;

		//make a test job with customer set to test customer and
		//status set to needs approval
		$j1 = new job();
		$jobNid = $j1->main($customerNid,'','job description','',$fTerms['job_statuses']['needs approval'])->nid;

		//make a fixit person
		$f1 = new person();
		$fixitNid = $f1->new_person_node('(512) 777-8888',
						$fTerms['person_types']['fixit'],
						'frankfirst',
						'franklast',
						'')->nid;

		//make a text out
		$t1 = new text_out();
		$textNid = $t1->main($jobNid,
							'',
							$fixitNid,
							'do you want a job',
							'',
							$fTerms['text_out_types']['relay to fixit'],
							'(512) 777-8888')->nid;

		//make a simulated text message from the Fixit
		$newText = array('cell' => '5127778888',
						'sms' => 'sms for take job test - fixit',
						'mms' => '',
						'cell_formatted' => '(512) 777-8888');

		//simulate a text in
		$t1 = new text_in();
		if($t1->main($newText,$fTerms,$fSettings)['take_job']['value'] == 1){
			$testResults['take_job'] = 1;
		}else{
			//if it failed the first test, don't do the second
			return $testResults;
		}
		
		//now test for react (second test)
		//test to make sure job is set to taken
		
		$sql = "	select n.nid as text_nid,
					n.created as text_time,
					j.field_job_target_id as job_nid,
					s.field_status_tid as job_status
		from 		{field_data_field_cell_phone cp}
		join 		{field_data_field_person_type pt} on cp.entity_id = pt.entity_id
		join 		{field_data_field_fixit_ref fr} on fr.field_fixit_ref_target_id = cp.entity_id
		join 		{field_data_field_job j} on j.entity_id = fr.entity_id
		join 		{node n} on n.nid = fr.entity_id
		join		{field_data_field_status s} on s.entity_id = j.field_job_target_id
		where 		cp.field_cell_phone_value = :cell_formatted
		and 		pt.field_person_type_tid = :person_type
		and 		fr.bundle = 'text_out'
		and 		n.created > :tenMin
		order by	n.created desc";
		
		$tenMin = time() - $fSettings['job_relay_time']['value'];
		$person_type = $fTerms['person_types']['fixit'];
		$args = array(':cell_formatted' => $newText['cell_formatted'], ':person_type' => $person_type, ':tenMin' => $tenMin);
		$result = db_query($sql,$args)->fetchAssoc();

		if(isset($result) and !$result == NULL){
			if($result['job_status'] == $fTerms['job_statuses']['taken-not notified customer']) $testResults['take_job_react'] = 1;
		}
		
		//cleanup
		node_delete($customerNid);
		node_delete($jobNid);
		node_delete($fixitNid);
		node_delete($textNid);
	
	return $testResults;
	}
	
	
	
	
	
	
	
	
	private function text_in_feedback_test(array $fTerms, array $fSettings){
		//array to report test results
		//need customer
		//need fixit
		//need job with status taken-details sent
		//need text out to customer with type = request feedback
		//make a simulated incoming text message array
		//simulate a new text coming in
		//see if taken = 1 on array
		//record test result
		//query to see if job status was changed to taken
		//record test result
		//cleanup (delete) nodes
		//return results
		
		//array to report test results (prepulate with zeros)
		$testResults = array('feedback' => 0,
							'feedback_react' => 0);

		$c1 = new person();
		$customerNid = $c1->new_person_node('(512) 333-4444',
							$fTerms['person_types']['customer'],
							'chrisfirst',
							'chrislast',
							'')->nid;

		$f1 = new person();
		$fixitNid = $f1->new_person_node('(512) 777-8888',
							$fTerms['person_types']['fixit'],
							'frankfirst',
							'franklast',
							'')->nid;

		$j1 = new job();
		$jobNid = $j1->main($customerNid,$fixitNid,'job description','',$fTerms['job_statuses']['taken-details sent to fixit'])->nid;

		$t1 = new text_out();
		$textNid = $t1->main($jobNid,
							$customerNid,
							$fixitNid,
							'feedback request',
							'',
							$fTerms['text_out_types']['request feedback'],
							'(512) 333-4444')->nid;

		//make a simulated text message from the Fixit
		$newText = array('cell' => '5123334444',
						'sms' => 'feedback from customer',
						'mms' => '',
						'cell_formatted' => '(512) 333-4444');
						
		//simulate a text in
		$t1 = new text_in();
		if($t1->main($newText,$fTerms,$fSettings)['feedback']['value'] == 1){
			$testResults['feedback'] = 1;
		}else{
			//if it failed the first test, don't do the second
			return $testResults;
		}
						
		//now test for react (second test)
		//test to make sure feedback node exists
		
		$sql = "select 		n.nid as feedback_nid,
							n.created as created
				from		field_data_field_feedback f
				join		field_data_field_customer_ref cr on cr.entity_id = f.entity_id
				join		field_data_field_fixit_ref fr on fr.entity_id = f.entity_id
				join		node n on n.nid = f.entity_id
				where		n.created > :tenMin
				and			cr.field_customer_ref_target_id = :customer_nid
				and			fr.field_fixit_ref_target_id = :fixit_nid";

		$tenMin = time() - 600;
		$args = array(':customer_nid' => $customerNid,
						':fixit_nid' => $fixitNid,
						':tenMin' => $tenMin);
		$result = db_query($sql,$args)->fetchAssoc();
		if(isset($result) and !$result == NULL){
			$testResults['feedback_react'] = 1;
		}
		
		//cleanup
		node_delete($customerNid);
		node_delete($fixitNid);
		node_delete($jobNid);
		node_delete($textNid);
		node_delete($result['feedback_nid']);
	
	return $testResults;
	}
	
	
	
	
	private function text_in_add_to_job_test(array $fTerms, array $fSettings){
		//array to report test results
		//need customer
		//need job with customer same as above
		//make a simulated incoming text message array
		//simulate a new text coming in
		//see if add_to_job = 1 on array
		//record test result
		
		//query to see if job status was changed to taken
		//record test result
		//cleanup (delete) nodes
		//return results
		
		//array to report test results (prepulate with zeros)
		$testResults = array('add_to_job' => 0,
							'add_to_job_react' => 0);

		$c1 = new person();
		$customerNid = $c1->new_person_node('(512) 333-4444',
							$fTerms['person_types']['customer'],
							'chrisfirst',
							'chrislast',
							'')->nid;

		$j1 = new job();
		$jobNid = $j1->main($customerNid,'','job description 1','',$fTerms['job_statuses']['needs approval'])->nid;

		//make a simulated text message from the Fixit
		$newText = array('cell' => '5123334444',
						'sms' => 'job description 2',
						'mms' => '',
						'cell_formatted' => '(512) 333-4444');
						
		//simulate a text in
		$t1 = new text_in();
		if($t1->main($newText,$fTerms,$fSettings)['add_to_job']['value'] == 1){
			$testResults['add_to_job'] = 1;
		}else{
			//if it failed the first test, don't do the second
			return $testResults;
		}
						
		//now test for react (second test)
		//test to make sure job sms field is set to new value
		if(($j1->get_job_info($jobNid)['sms']) == 'job description 2') $testResults['add_to_job_react'] = 1;
		
		//cleanup
		node_delete($customerNid);
		node_delete($jobNid);
		
	return $testResults;
	}
	
	
	
	
	private function text_in_update_zip_test(array $fTerms, array $fSettings){
		//array to report test results
		//need customer
		//make a simulated incoming text message array (with zip in sms field)
		//simulate a new text coming in
		//see if update_zip = 1 on array
		//record test result
		//query to see if job status was changed to taken
		//record test result
		//cleanup (delete) nodes
		//return results
		
		//array to report test results (prepulate with zeros)
		$testResults = array('update_zip' => 0,
							'update_zip_react' => 0);

		$c1 = new person();
		$customerNid = $c1->new_person_node('(512) 333-4444',
							$fTerms['person_types']['customer'],
							'chrisfirst',
							'chrislast',
							78758)->nid;

		//make a simulated text message from the customer
		$newText = array('cell' => '5123334444',
						'sms' => 'word 78704 word',
						'mms' => '',
						'cell_formatted' => '(512) 333-4444');
						
		//simulate a text in
		$t1 = new text_in();
		if($t1->main($newText,$fTerms,$fSettings)['update_zip']['value'] == 1){
			$testResults['update_zip'] = 1;
		}else{
			//if it failed the first test, don't do the second
			return $testResults;
		}
						
		//now test for react (second test)
		//see if the zip was changed
		if($c1->get_person_info($customerNid)['zip'] == 78704) $testResults['update_zip_react'] = 1;
		
		//cleanup
		node_delete($customerNid);
		
	return $testResults;
	}
	
	
	
	
	private function text_in_new_fixit_test(array $fTerms, array $fSettings){
		//array to report test results
		//make a simulated incoming text message array (with zip in sms field)
		//simulate a new text coming in
		//see if new_fixit = 1 on array
		//record test result
		
		//array to report test results (prepulate with zeros)
		$testResults = array('new_fixit' => 0,
							'new_fixit_react' => 0);

		//make a simulated text message from the customer
		$newText = array('cell' => '5127778889',
						'sms' => 'hhh contractor jjj 12344',
						'mms' => '',
						'cell_formatted' => '(512) 777-8889');
						
		//simulate a text in
		$t1 = new text_in();
		$textInDetails = $t1->main($newText,$fTerms,$fSettings);
		if($textInDetails['new_fixit']['value'] == 1){
			$testResults['new_fixit'] = 1;
		}else{
			//if it failed the first test, don't do the second
			return $testResults;
		}
		
		//now test for react (second test)
		//test to make sure new fixit exists
		
		$sql = "	select cp.entity_id as fixit_nid
		from 		{field_data_field_cell_phone cp}
		where 		cp.field_cell_phone_value = :cell_formatted";
		
		$args = array(':cell_formatted' => $newText['cell_formatted']);
		$result = db_query($sql,$args)->fetchAssoc();

		if(isset($result) and !$result == NULL){
			$testResults['new_fixit_react'] = 1;

			//cleanup
			node_delete($result['fixit_nid']);
		}
	
	return $testResults;
	}
	
	
	
	
	private function text_in_new_customer_test(array $fTerms, array $fSettings){
		//array to report test results
		//make a simulated incoming text message array (with zip in sms field)
		//simulate a new text coming in
		//see if new_customer = 1 on array
		//record test result
		
		//array to report test results (prepulate with zeros)
		$testResults = array('new_customer' => 0,
							'new_customer_react' => 0);

		//make a simulated text message from the customer
		$newText = array('cell' => '5123334445',
						'sms' => 'hhh blah jjj 12344',
						'mms' => '',
						'cell_formatted' => '(512) 333-4445');
						
		//simulate a text in
		$t1 = new text_in();
		$textInDetails = $t1->main($newText,$fTerms,$fSettings);
		if($textInDetails['new_customer']['value'] == 1){
			$testResults['new_customer'] = 1;
		}else{
			//if it failed the first test, don't do the second
			return $testResults;
		}
		
		//now test for react (second test)
		//test to make sure new customer exists
		
		$sql = "	select 		cp.entity_id as customer_nid,
								n.created as when_created,
								cr.entity_id as job_nid
					from 		{field_data_field_cell_phone cp}
					left join	{field_data_field_customer_ref cr} on cr.field_customer_ref_target_id = cp.entity_id
					join		{node n} on n.nid = cp.entity_id
					where 		cp.field_cell_phone_value = :cell_formatted
					and			n.created > :oneMin";
		
		$oneMin = time() - 60;
		$args = array(':cell_formatted' => $newText['cell_formatted'],
						':oneMin' => $oneMin);
		$result = db_query($sql,$args)->fetchAssoc();

		if(isset($result) and !$result == NULL){
			$testResults['new_customer_react'] = 1;

			//cleanup
			node_delete($result['customer_nid']);
			node_delete($result['job_nid']);
		}
	
	return $testResults;
	}
	
	
	
	
	private function text_in_new_job_test(array $fTerms, array $fSettings){
		//array to report test results
		//make a new customer
		//make a simulated incoming text message array (with zip in sms field)
		//simulate a new text coming in
		//see if new_customer = 1 on array
		//record test result
		
		//array to report test results (prepulate with zeros)
		$testResults = array('new_job' => 0,
							'new_job_react' => 0);

		$c1 = new person();
		$customerNid = $c1->new_person_node('(512) 333-4445',
						$fTerms['person_types']['customer'],
						'chrisfirst',
						'chrislast',
						'')->nid;

		//make a simulated text message from the customer
		$newText = array('cell' => '5123334445',
						'sms' => 'hhh blah jjj hhh',
						'mms' => '',
						'cell_formatted' => '(512) 333-4445');
						
		//simulate a text in
		$t1 = new text_in();
		$textInDetails = $t1->main($newText,$fTerms,$fSettings);
		if($textInDetails['new_job']['value'] == 1){
			$testResults['new_job'] = 1;
		}else{
			//if it failed the first test, don't do the second
			return $testResults;
		}
		
		//now test for react (second test)
		//test to make sure new customer exists
		
		$sql = "	select 		cr.entity_id as job_nid
					from 		{field_data_field_cell_phone cp}
					join		field_data_field_customer_ref cr on cr.field_customer_ref_target_id = cp.entity_id
					where 		cp.field_cell_phone_value = :cell_formatted";
		
		$args = array(':cell_formatted' => $newText['cell_formatted']);
		$result = db_query($sql,$args)->fetchAssoc();

		if(isset($result) and !$result == NULL){
			$testResults['new_job_react'] = 1;

			//cleanup
			node_delete($result['job_nid']);
			node_delete($customerNid);
			
		}
	
	return $testResults;
	}
	
	
	
	
	
	
	
	
	
	private function jobs_relay_needs_approval_test(array $fTerms, array $fSettings){
		//array to report test results
		//make a new customer
		//make a new job
		//call hellofixit_cron
		//see if there is a text out
		//record test result
		//cleanup
		
		//array to report test results (prepulate with zeros)
		$testResults = array('needs_approval' => 0);

		$c1 = new person();
		$customerNid = $c1->new_person_node('(512) 333-4445',
						$fTerms['person_types']['customer'],
						'chrisfirst',
						'chrislast',
						'')->nid;
						
		//make a test job with customer set to test customer and
		//status set to needs approval
		$j1 = new job();
		$jobNid = $j1->main($customerNid,'','job aaa bbb','',$fTerms['job_statuses']['needs approval'])->nid;

		//run the jobs relay
		hellofixit_cron($fSettings['cron_pw']['value']);

		//find the text out that was just created
		$sql = "	select 		cr.entity_id as text_out_nid
					from 		field_data_field_customer_ref cr
					join		node n on n.nid = cr.entity_id
					where 		cr.field_customer_ref_target_id = :customerNid
					and			cr.bundle = 'text_out'
					and			n.created > :oneMin";
					
		$oneMin = time() - 60;
		$args = array(	':customerNid' => $customerNid,
						':oneMin' => $oneMin);

		$result = db_query($sql,$args)->fetchAssoc();

		if(isset($result) and !$result == NULL) $testResults['needs_approval'] = 1;

		//cleanup
		node_delete($customerNid);
		node_delete($jobNid);
		node_delete($result['text_out_nid']);
	
	return $testResults;
	}

	

	
	




	}
